name: Build and publish

on:
  workflow_dispatch
  
permissions:
  id-token: write
  contents: read
  pages: write

jobs:
  build_pages:
    environment:
      name: github-pages
    runs-on: ubuntu-latest
    env:
      ANT_OPTS: -Xmx6g
      TYPESENSE_HOST: typesense.acdh-dev.oeaw.ac.at
      TYPESENSE_PORT: 443
      TYPESENSE_PROTOCOL: https
      TYPESENSE_API_KEY: ${{ secrets.TYPESENSE_API_KEY }}
    steps:
      - name: Perform Checkout
        uses: actions/checkout@v4
      - name: Install Saxon, Ant and Fundament
        run: |
          apt-get update && apt-get install openjdk-11-jre-headless ant -y --no-install-recommends
          ./script.sh
      - name: Install Ant-Contrib and Python
        run: |
          pip install -r requirements.txt
      - name: Fetch and preprocess Data
        run: |
          ./fetch_data.sh
      - name: Build
        run: |
          ant
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: github-pages
          path: ./html
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

